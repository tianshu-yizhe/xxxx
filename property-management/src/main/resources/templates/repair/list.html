<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/header :: header('维修管理')">
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>维修管理</h2>
        <button sec:authorize="hasAnyRole('ADMIN', 'RESIDENT')" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRepairModal">
            <i class="bi bi-plus-lg"></i> 提交维修申请
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <ul class="nav nav-tabs mb-4" id="repairTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button">
                        全部
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button">
                        待处理
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="processing-tab" data-bs-toggle="tab" data-bs-target="#processing" type="button">
                        处理中
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button">
                        已完成
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="repairTabsContent">
                <div class="tab-pane fade show active" id="all" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>标题</th>
                                <th>住户</th>
                                <th>提交时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="repair : ${repairs}">
                                <td>
                                    <a th:href="@{/repairs/{id}(id=${repair.id})}" th:text="${repair.title}"></a>
                                </td>
                                <td th:text="${repair.resident.name + ' (' + repair.resident.roomNumber + ')'}"></td>
                                <td th:text="${#temporals.format(repair.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                                <td>
                                        <span th:class="${repair.status == 'PENDING'} ? 'badge bg-secondary' :
                                                 ${repair.status == 'PROCESSING'} ? 'badge bg-primary' : 'badge bg-success'"
                                              th:text="${repair.status}"></span>
                                </td>
                                <td>
                                    <a th:href="@{/repairs/{id}(id=${repair.id})}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> 查看
                                    </a>
                                    <button sec:authorize="hasRole('ADMIN')"
                                            class="btn btn-sm btn-outline-info ms-2"
                                            data-bs-toggle="modal"
                                            data-bs-target="#updateRepairStatusModal"
                                            th:attr="data-id=${repair.id}, data-status=${repair.status}">
                                        <i class="bi bi-arrow-repeat"></i> 更新
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 其他标签页内容 -->
            </div>
        </div>
    </div>
</div>

<!-- 添加维修申请模态框 -->
<div class="modal fade" id="addRepairModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">提交维修申请</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form th:action="@{/repairs}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">标题</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">详细描述</label>
                        <textarea class="form-control" id="description" name="description" rows="5" required></textarea>
                    </div>
                    <div sec:authorize="hasRole('ADMIN')" class="mb-3">
                        <label for="residentId" class="form-label">住户</label>
                        <select class="form-select" id="residentId" name="residentId" required>
                            <option th:each="resident : ${residents}"
                                    th:value="${resident.id}"
                                    th:text="${resident.name + ' (' + resident.roomNumber + ')'}"></option>
                        </select>
                    </div>
                    <input sec:authorize="hasRole('RESIDENT')" type="hidden" name="residentId" th:value="${currentUser.residentId}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">提交</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 更新维修状态模态框 -->
<div sec:authorize="hasRole('ADMIN')" class="modal fade" id="updateRepairStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">更新维修状态</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form th:action="@{/repairs/{id}/status(id=${repair.id})}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="status" class="form-label">状态</label>
                        <select class="form-select" id="status" name="status" required>
                            <option th:each="status : ${T(com.property.model.Repair).STATUSES}"
                                    th:value="${status}"
                                    th:text="${status}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="staffNotes" class="form-label">处理备注</label>
                        <textarea class="form-control" id="staffNotes" name="staffNotes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">更新</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>
<script th:src="@{/js/repair.js}"></script>
</body>
</html>