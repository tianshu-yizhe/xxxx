<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/header :: header('费用管理')">
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>费用管理</h2>
        <button sec:authorize="hasRole('ADMIN')" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFeeModal">
            <i class="bi bi-plus-lg"></i> 添加费用
        </button>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <ul class="nav nav-tabs mb-4" id="feeTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button">
                        全部费用
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="unpaid-tab" data-bs-toggle="tab" data-bs-target="#unpaid" type="button">
                        未支付
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="paid-tab" data-bs-toggle="tab" data-bs-target="#paid" type="button">
                        已支付
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="feeTabsContent">
                <div class="tab-pane fade show active" id="all" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>住户</th>
                                <th>类型</th>
                                <th>金额</th>
                                <th>到期日</th>
                                <th>状态</th>
                                <th sec:authorize="hasRole('ADMIN')">操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="fee : ${fees}">
                                <td th:text="${fee.resident.name + ' (' + fee.resident.roomNumber + ')'}"></td>
                                <td th:text="${fee.type}"></td>
                                <td th:text="${'¥' + #numbers.formatDecimal(fee.amount, 1, 2)}"></td>
                                <td th:text="${#temporals.format(fee.dueDate, 'yyyy-MM-dd')}"></td>
                                <td>
                                        <span th:class="${fee.status == 'PAID'} ? 'badge bg-success' :
                                                 ${fee.status == 'OVERDUE'} ? 'badge bg-danger' : 'badge bg-warning'"
                                              th:text="${fee.status}"></span>
                                </td>
                                <td sec:authorize="hasRole('ADMIN')">
                                    <button class="btn btn-sm btn-outline-primary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#updateFeeStatusModal"
                                            th:attr="data-id=${fee.id}, data-status=${fee.status}">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="unpaid" role="tabpanel">
                    <!-- 类似结构，只显示未支付费用 -->
                </div>

                <div class="tab-pane fade" id="paid" role="tabpanel">
                    <!-- 类似结构，只显示已支付费用 -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加费用模态框 -->
<div sec:authorize="hasRole('ADMIN')" class="modal fade" id="addFeeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加费用</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form th:action="@{/fees}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="residentId" class="form-label">住户</label>
                        <select class="form-select" id="residentId" name="residentId" required>
                            <option value="">选择住户</option>
                            <option th:each="resident : ${residents}"
                                    th:value="${resident.id}"
                                    th:text="${resident.name + ' (' + resident.roomNumber + ')'}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="type" class="form-label">费用类型</label>
                        <select class="form-select" id="type" name="type" required>
                            <option value="">选择类型</option>
                            <option value="PROPERTY">物业费</option>
                            <option value="WATER">水费</option>
                            <option value="ELECTRICITY">电费</option>
                            <option value="PARKING">停车费</option>
                            <option value="OTHER">其他</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="amount" class="form-label">金额</label>
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" class="form-control" id="amount" name="amount" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="dueDate" class="form-label">到期日</label>
                        <input type="date" class="form-control" id="dueDate" name="dueDate" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 更新费用状态模态框 -->
<div class="modal fade" id="updateFeeStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">更新费用状态</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form th:action="@{/fees/{id}/status(id=${fee.id})}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="status" class="form-label">状态</label>
                        <select class="form-select" id="status" name="status" required>
                            <option th:each="status : ${T(com.property.model.Fee).STATUSES}"
                                    th:value="${status}"
                                    th:text="${status}"></option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">更新</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>
<script th:src="@{/js/fee.js}"></script>
</body>
</html>